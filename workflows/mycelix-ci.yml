name: Mycelix CI

on:
  push:
    branches: [main]
    paths:
      - 'mycelix-workspace/**'
      - 'mycelix-finance/**'
      - 'mycelix-identity/**'
      - 'mycelix-governance/**'
      - 'mycelix-justice/**'
      - 'mycelix-media/**'
      - 'mycelix-property/**'
      - 'mycelix-space/**'
      - 'mycelix-health/**'
      - 'mycelix-energy/**'
      - 'mycelix-climate/**'
      - 'mycelix-edunet/**'
      - 'mycelix-marketplace/**'
      - 'mycelix-supplychain/**'
      - 'Mycelix-Core/**'
      - 'Mycelix-Mail/**'
      - '.github/workflows/mycelix-ci.yml'
  pull_request:
    branches: [main]
    paths:
      - 'mycelix-workspace/**'
      - 'mycelix-finance/**'
      - 'mycelix-identity/**'
      - 'mycelix-governance/**'
      - 'mycelix-justice/**'
      - 'mycelix-media/**'
      - 'mycelix-property/**'
      - 'mycelix-space/**'
      - 'mycelix-health/**'
      - 'mycelix-energy/**'
      - 'mycelix-climate/**'
      - 'mycelix-edunet/**'
      - 'mycelix-marketplace/**'
      - 'mycelix-supplychain/**'
      - 'Mycelix-Core/**'
      - 'Mycelix-Mail/**'

env:
  CARGO_TERM_COLOR: always
  NODE_VERSION: '20'
  RUST_VERSION: 'stable'  # Use latest stable Rust (system has 1.92.0)

jobs:
  # ============================================================================
  # TypeScript SDK Tests
  # ============================================================================
  typescript-sdk:
    name: TypeScript SDK
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: mycelix-workspace/sdk-ts

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: mycelix-workspace/sdk-ts/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Type check
        run: npm run typecheck

      - name: Lint
        run: npm run lint
        # Linting errors should be addressed

      - name: Run tests
        run: npm test

      - name: Run tests with coverage
        run: npm run test:coverage

      - name: Upload coverage
        uses: codecov/codecov-action@v3
        with:
          files: mycelix-workspace/sdk-ts/coverage/coverage-final.json
          flags: typescript-sdk
          fail_ci_if_error: false

      - name: Build
        run: npm run build

      - name: Run benchmarks
        run: npm run bench
        continue-on-error: true

  # ============================================================================
  # Rust SDK Tests
  # ============================================================================
  rust-sdk:
    name: Rust SDK
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: mycelix-workspace/sdk

    steps:
      - uses: actions/checkout@v4

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: ${{ env.RUST_VERSION }}
          components: clippy, rustfmt
          targets: wasm32-unknown-unknown

      - name: Cache cargo
        uses: actions/cache@v3
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: ${{ runner.os }}-cargo-sdk-${{ hashFiles('**/Cargo.lock') }}

      - name: Check formatting
        run: cargo fmt --check

      - name: Check compilation (native)
        run: cargo check --features simulation

      - name: Check compilation (WASM)
        run: cargo check --target wasm32-unknown-unknown --features holochain

      - name: Clippy
        run: cargo clippy --features simulation -- -D warnings

      - name: Run tests
        run: cargo test --features simulation

      - name: Build release (native)
        run: cargo build --release --features simulation

      - name: Build release (WASM)
        run: cargo build --release --target wasm32-unknown-unknown --features holochain

  # ============================================================================
  # hApp Compilation Check (all individual hApp repos)
  # ============================================================================
  happ-check:
    name: hApp Compilation
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        happ:
          - { name: finance, path: mycelix-finance }
          - { name: identity, path: mycelix-identity }
          - { name: governance, path: mycelix-governance }
          - { name: justice, path: mycelix-justice }
          - { name: media, path: mycelix-media }
          - { name: property, path: mycelix-property }
          - { name: space, path: mycelix-space }
          - { name: health, path: mycelix-health }
          - { name: energy, path: mycelix-energy }
          - { name: climate, path: mycelix-climate }
          - { name: edunet, path: mycelix-edunet }
          - { name: marketplace, path: mycelix-marketplace/backend }
          - { name: supplychain, path: mycelix-supplychain/holochain }
          - { name: mail, path: Mycelix-Mail/holochain }

    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: ${{ env.RUST_VERSION }}
          targets: wasm32-unknown-unknown

      - name: Cache cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            ${{ matrix.happ.path }}/target/
          key: ${{ runner.os }}-cargo-${{ matrix.happ.name }}-${{ hashFiles(format('{0}/Cargo.lock', matrix.happ.path)) }}

      - name: Check ${{ matrix.happ.name }} (WASM)
        run: cargo build --target wasm32-unknown-unknown
        working-directory: ${{ matrix.happ.path }}

  # ============================================================================
  # Holochain Zome Tests
  # ============================================================================
  holochain-zomes:
    name: Holochain Zomes
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: Mycelix-Core

    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: ${{ env.RUST_VERSION }}
          targets: wasm32-unknown-unknown

      - name: Cache cargo
        uses: actions/cache@v3
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: ${{ runner.os }}-cargo-zomes-${{ hashFiles('**/Cargo.lock') }}

      - name: Check zome compilation
        run: |
          cargo check -p bridge_integrity -p bridge_coordinator
          cargo check -p fl_integrity -p fl_coordinator

      - name: Build WASM
        run: |
          cargo build --release --target wasm32-unknown-unknown \
            -p bridge_integrity \
            -p bridge_coordinator \
            -p fl_integrity \
            -p fl_coordinator

      - name: Run zome tests
        run: cargo test --all

  # ============================================================================
  # Unit Tests (fast, no conductor)
  # ============================================================================
  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    needs: [typescript-sdk, rust-sdk]

    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: ${{ env.RUST_VERSION }}

      - name: Cache cargo
        uses: actions/cache@v3
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: ${{ runner.os }}-cargo-unit-${{ hashFiles('**/Cargo.lock') }}

      - name: Run Rust unit tests
        run: |
          cargo test --lib --all-features -p bridge_integrity -p bridge_coordinator 2>&1 || true
          cargo test --lib --all-features -p fl_integrity -p fl_coordinator 2>&1 || true
        working-directory: Mycelix-Core

      - name: Run SDK unit tests
        run: cargo test --lib --features simulation
        working-directory: mycelix-workspace/sdk

      - name: Run TypeScript unit tests
        run: npm test -- --testPathPattern="\.unit\."
        working-directory: mycelix-workspace/sdk-ts

  # ============================================================================
  # Integration Tests (with Holochain conductor)
  # ============================================================================
  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: [holochain-zomes, unit-tests]
    timeout-minutes: 30

    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install Nix
        uses: cachix/install-nix-action@v24
        with:
          nix_path: nixpkgs=channel:nixos-unstable
          extra_nix_config: |
            experimental-features = nix-command flakes

      - name: Setup Holochain cache
        run: |
          nix-env -iA cachix -f https://cachix.org/api/v1/install
          cachix use holochain-ci

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: ${{ env.RUST_VERSION }}
          targets: wasm32-unknown-unknown

      - name: Install Holochain binaries
        run: |
          nix-shell --run "holochain --version && hc --version && lair-keystore --version" || {
            echo "Installing Holochain via cargo..."
            cargo install holochain --version 0.4.0 || true
            cargo install hc --version 0.4.0 || true
            cargo install lair_keystore --version 0.5.0 || true
          }

      - name: Build DNA bundles
        run: |
          # Build WASM targets
          cargo build --release --target wasm32-unknown-unknown \
            -p bridge_integrity \
            -p bridge_coordinator \
            -p fl_integrity \
            -p fl_coordinator

          # Package DNAs if hc is available
          if command -v hc &> /dev/null; then
            hc dna pack Mycelix-Core/zomes/bridge/workdir -o Mycelix-Core/zomes/bridge/workdir/bridge.dna || true
            hc dna pack Mycelix-Core/zomes/federated_learning/workdir -o Mycelix-Core/zomes/federated_learning/workdir/fl.dna || true
          fi
        working-directory: Mycelix-Core

      - name: Start Holochain conductor
        id: conductor
        run: |
          # Create temporary directories
          mkdir -p /tmp/holochain-test/{conductor,keystore}

          # Generate lair passphrase
          LAIR_PASSPHRASE=$(openssl rand -base64 32)
          echo "LAIR_PASSPHRASE=$LAIR_PASSPHRASE" >> $GITHUB_ENV

          # Create conductor config
          cat > /tmp/holochain-test/conductor-config.yaml << 'EOF'
          data_root_path: /tmp/holochain-test/conductor
          keystore:
            type: lair_server_in_proc
          admin_interfaces:
            - driver:
                type: websocket
                port: 4444
          network:
            bootstrap_service: https://bootstrap.holo.host
            transport_pool:
              - type: webrtc
                signal_url: wss://signal.holo.host
          EOF

          # Start conductor in background
          if command -v holochain &> /dev/null; then
            echo "$LAIR_PASSPHRASE" | holochain -c /tmp/holochain-test/conductor-config.yaml &
            CONDUCTOR_PID=$!
            echo "conductor_pid=$CONDUCTOR_PID" >> $GITHUB_OUTPUT
            sleep 10
            echo "Conductor started with PID: $CONDUCTOR_PID"
          else
            echo "Holochain not available, skipping conductor start"
          fi

      - name: Run zome integration tests
        run: |
          # Test bridge zome calls
          echo "Testing bridge zome integration..."
          cargo test --test integration -- --test-threads=1 2>&1 || echo "Bridge integration tests skipped"

          # Test federated learning zome calls
          echo "Testing FL zome integration..."
          cargo test --test integration -- --test-threads=1 2>&1 || echo "FL integration tests skipped"
        working-directory: Mycelix-Core
        env:
          HOLOCHAIN_ADMIN_URL: ws://localhost:4444

      - name: Run cross-zome communication tests
        run: |
          echo "Testing cross-zome communication..."
          # Test bridge -> FL communication
          cargo test cross_zome -- --test-threads=1 2>&1 || echo "Cross-zome tests not found"
        working-directory: Mycelix-Core
        env:
          HOLOCHAIN_ADMIN_URL: ws://localhost:4444

      - name: Run TypeScript integration tests
        run: |
          npm ci
          npm run test:integration || echo "Integration tests not configured"
        working-directory: mycelix-workspace/sdk-ts
        env:
          HOLOCHAIN_ADMIN_URL: ws://localhost:4444

      - name: Cleanup conductor
        if: always()
        run: |
          if [ -n "${{ steps.conductor.outputs.conductor_pid }}" ]; then
            kill ${{ steps.conductor.outputs.conductor_pid }} 2>/dev/null || true
          fi
          rm -rf /tmp/holochain-test

  # ============================================================================
  # E2E Tests (multi-agent scenarios)
  # ============================================================================
  e2e-tests:
    name: E2E Multi-Agent Tests
    runs-on: ubuntu-latest
    needs: [integration-tests]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    timeout-minutes: 45

    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install Nix
        uses: cachix/install-nix-action@v24
        with:
          nix_path: nixpkgs=channel:nixos-unstable
          extra_nix_config: |
            experimental-features = nix-command flakes

      - name: Setup Holochain cache
        run: |
          nix-env -iA cachix -f https://cachix.org/api/v1/install
          cachix use holochain-ci

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: ${{ env.RUST_VERSION }}
          targets: wasm32-unknown-unknown

      - name: Build DNA bundles
        run: |
          cargo build --release --target wasm32-unknown-unknown \
            -p bridge_integrity \
            -p bridge_coordinator \
            -p fl_integrity \
            -p fl_coordinator
        working-directory: Mycelix-Core

      - name: Setup multi-conductor environment
        run: |
          # Create directories for 3 conductors
          for i in 1 2 3; do
            mkdir -p /tmp/holo-e2e/conductor-$i/{data,keystore}

            # Generate conductor config with unique ports
            ADMIN_PORT=$((4440 + $i))
            APP_PORT=$((8880 + $i))

            cat > /tmp/holo-e2e/conductor-$i/config.yaml << EOF
          data_root_path: /tmp/holo-e2e/conductor-$i/data
          keystore:
            type: lair_server_in_proc
          admin_interfaces:
            - driver:
                type: websocket
                port: $ADMIN_PORT
          app_interfaces:
            - driver:
                type: websocket
                port: $APP_PORT
          network:
            bootstrap_service: https://bootstrap.holo.host
            transport_pool:
              - type: webrtc
                signal_url: wss://signal.holo.host
          EOF
          done

      - name: Start multi-conductor network
        id: multi_conductor
        run: |
          PIDS=""

          for i in 1 2 3; do
            PASSPHRASE=$(openssl rand -base64 32)
            echo "CONDUCTOR_${i}_PASSPHRASE=$PASSPHRASE" >> $GITHUB_ENV

            if command -v holochain &> /dev/null; then
              echo "$PASSPHRASE" | holochain -c /tmp/holo-e2e/conductor-$i/config.yaml &
              PID=$!
              PIDS="$PIDS $PID"
              echo "Started conductor $i with PID $PID"
            fi
          done

          echo "conductor_pids=$PIDS" >> $GITHUB_OUTPUT
          sleep 15
          echo "All conductors started"

      - name: Run multi-agent E2E tests
        run: |
          echo "Running multi-agent E2E scenarios..."

          # Federated learning multi-agent test
          echo "Testing FL model aggregation across agents..."
          cargo test e2e_agent -- --test-threads=1 --ignored 2>&1 || echo "E2E agent tests not found"

          # Bridge reputation propagation test
          echo "Testing cross-hApp reputation propagation..."
          cargo test e2e_reputation -- --test-threads=1 --ignored 2>&1 || echo "E2E reputation tests not found"

          # Credential verification flow test
          echo "Testing credential verification flow..."
          cargo test e2e_credentials -- --test-threads=1 --ignored 2>&1 || echo "E2E credential tests not found"
        working-directory: Mycelix-Core
        env:
          CONDUCTOR_1_ADMIN_URL: ws://localhost:4441
          CONDUCTOR_1_APP_URL: ws://localhost:8881
          CONDUCTOR_2_ADMIN_URL: ws://localhost:4442
          CONDUCTOR_2_APP_URL: ws://localhost:8882
          CONDUCTOR_3_ADMIN_URL: ws://localhost:4443
          CONDUCTOR_3_APP_URL: ws://localhost:8883

      - name: Run network partition tests
        run: |
          echo "Testing network partition recovery..."
          # Simulate network partition by stopping conductor 2
          if [ -n "${{ steps.multi_conductor.outputs.conductor_pids }}" ]; then
            PIDS=(${{ steps.multi_conductor.outputs.conductor_pids }})
            if [ ${#PIDS[@]} -ge 2 ]; then
              kill ${PIDS[1]} 2>/dev/null || true
              sleep 5

              # Verify remaining conductors can still communicate
              cargo test network_partition -- --test-threads=1 --ignored 2>&1 || echo "Partition test not found"
            fi
          fi
        working-directory: Mycelix-Core

      - name: Run Byzantine fault tolerance tests
        run: |
          echo "Testing Byzantine fault tolerance..."
          cargo test byzantine -- --test-threads=1 --ignored 2>&1 || echo "Byzantine tests not found"
        working-directory: Mycelix-Core

      - name: Cleanup E2E environment
        if: always()
        run: |
          if [ -n "${{ steps.multi_conductor.outputs.conductor_pids }}" ]; then
            for PID in ${{ steps.multi_conductor.outputs.conductor_pids }}; do
              kill $PID 2>/dev/null || true
            done
          fi
          rm -rf /tmp/holo-e2e

  # ============================================================================
  # Smoke Tests (quick validation on PRs)
  # ============================================================================
  smoke-tests:
    name: Smoke Tests
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'

    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: ${{ env.RUST_VERSION }}
          targets: wasm32-unknown-unknown

      - name: Quick compilation check
        run: |
          cargo check -p bridge_integrity -p bridge_coordinator
          cargo check -p fl_integrity -p fl_coordinator
        working-directory: Mycelix-Core

      - name: Run critical path tests
        run: |
          cargo test --lib critical_ -- --test-threads=4 2>&1 || true
        working-directory: Mycelix-Core

  # ============================================================================
  # Security Scanning
  # ============================================================================
  security:
    name: Security Scan
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          severity: 'CRITICAL,HIGH'
          exit-code: '1'  # Fail on vulnerabilities (security-critical)

      - name: Audit npm packages
        run: |
          cd mycelix-workspace/sdk-ts
          # Fail on high/critical vulnerabilities - security must not be bypassed
          npm audit --audit-level=high

      - name: Audit Rust packages
        run: |
          cargo install cargo-audit || true
          cd mycelix-workspace/sdk
          # Fail on vulnerabilities - security must not be bypassed
          cargo audit

  # ============================================================================
  # CI Pass Check (ensures all required jobs succeed)
  # ============================================================================
  ci-pass:
    name: CI Pass
    if: ${{ always() }}
    runs-on: ubuntu-latest
    needs:
      - typescript-sdk
      - rust-sdk
      - happ-check
      - holochain-zomes
      - unit-tests
      - integration-tests
      - smoke-tests
      - security

    steps:
      - name: Check all jobs passed
        uses: re-actors/alls-green@release/v1
        with:
          allowed-skips: smoke-tests, e2e-tests
          jobs: ${{ toJSON(needs) }}

      - name: Summary
        if: always()
        run: |
          echo "## CI Pipeline Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| TypeScript SDK | ${{ needs.typescript-sdk.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Rust SDK | ${{ needs.rust-sdk.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| hApp Compilation | ${{ needs.happ-check.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Holochain Zomes | ${{ needs.holochain-zomes.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Unit Tests | ${{ needs.unit-tests.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Integration Tests | ${{ needs.integration-tests.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Smoke Tests | ${{ needs.smoke-tests.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Security | ${{ needs.security.result }} |" >> $GITHUB_STEP_SUMMARY
